<!-- _includes/head-custom.html -->

<!-- 見た目の微調整 -->
<style>
  .page-header { padding-top: 10px; padding-bottom: 10px; }
  .page-header h1 { font-size: 2rem; line-height: 1.2; margin: 0; }
  @media screen and (min-width: 64em) {
    .main-content { font-size: 1rem; color: #333333; }
  }
  /* display 数式の中央寄せ＆余白 */
  .mjx-display { text-align: center; }
  .mjx-display > div { display: inline-block; margin-top: 1em; margin-bottom: 1em; }
</style>

<!-- MathJax 設定 -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true   // ← v3 では tex 配下
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    svg: { fontCache: 'global' },
    // レンダ前に「前後が空白でない $...$」を \( ... \) に自動補正（改行は跨がない）
    startup: {
      ready: () => {
        try {
          // CJK(日本語)に密着している $...$ の前後に半角スペースを自動挿入
          const CJK = '[\\u3040-\\u30FF\\u3400-\\u9FFF\\u3000-\\u303F]'; // ひら/カタ/漢字/全角記号
          const reLeft  = new RegExp(`(${CJK})\\$(?!\\$)([^$\\n]+?)\\$`, 'gu');
          const reRight = new RegExp(`\\$(?!\\$)([^$\\n]+?)\\$(${CJK})`, 'gu');

          const walk = (node) => {
            if (node.nodeType === 3) {
              // 既に \( \) / \[ \] を含むテキストは触らない
              if (node.nodeValue.includes('\\(') || node.nodeValue.includes('\\[')) return;

              let v = node.nodeValue;
              // 左がCJKに密着 → CJK と $ の間にスペース
              v = v.replace(reLeft, (_, a, m) => `${a} $${m}$`);
              // 右がCJKに密着 → $ と CJK の間にスペース
              v = v.replace(reRight, (_, m, b) => `$${m}$ ${b}`);
              node.nodeValue = v;
            } else if (node.nodeType === 1 && !/^(script|style|code|pre|textarea)$/i.test(node.tagName)) {
              for (const c of Array.from(node.childNodes)) walk(c);
            }
          };
          walk(document.body);
        } catch (e) { console.warn('inline-math spacing prepass skipped:', e); }
        MathJax.startup.defaultReady();
      }
    }
  };
</script>

<!-- MathJax 本体 -->
<script id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>

<!-- 画像をクリックで原画像を新規タブで開く -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('main img').forEach(img => {
      if (!img.closest('a')) {
        const a = document.createElement('a');
        a.href = img.src;
        a.target = '_blank';
        a.rel = 'noopener';
        img.replaceWith(a);
        a.appendChild(img);
      }
    });
  });
</script>
